name: Build FR-DETR ONNX

on:
  workflow_dispatch:
    inputs:
      model_size:
        description: "FR-DETR model size (Nano, Small, Medium, Large)"
        required: true
        default: "Nano"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Build FR-DETR ONNX
        run: |
          docker build . \
            --build-arg MODEL_SIZE=${{ inputs.model_size }} \
            --output . \
            -f- <<'EOF'
          FROM python:3.11 AS build

          RUN apt-get update && apt-get install --no-install-recommends -y libgl1 \
              && rm -rf /var/lib/apt/lists/*

          COPY --from=ghcr.io/astral-sh/uv:0.8.0 /uv /bin/

          WORKDIR /rfdetr

          RUN uv pip install --system \
              rfdetr[onnxexport] \
              torch==2.8.0 \
              onnx==1.19.1 \
              onnxscript

          ARG MODEL_SIZE

          RUN python3 <<'PY'
          from rfdetr import RFDETRNano, RFDETRSmall, RFDETRMedium, RFDETRLarge
          import os

          model_map = {
              "Nano": RFDETRNano,
              "Small": RFDETRSmall,
              "Medium": RFDETRMedium,
              "Large": RFDETRLarge,
          }

          size = os.environ["MODEL_SIZE"]
          model_cls = model_map[size]

          model = model_cls(resolution=320)
          model.export(simplify=True)
          PY

          FROM scratch
          ARG MODEL_SIZE
          COPY --from=build /rfdetr/output/inference_model.onnx /rfdetr-${MODEL_SIZE}.onnx
          EOF

      - name: Upload ONNX model
        uses: actions/upload-artifact@v4
        with:
          name: rfdetr-${{ inputs.model_size }}-onnx
          path: rfdetr-${{ inputs.model_size }}.onnx
